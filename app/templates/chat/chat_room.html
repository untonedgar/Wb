{% extends 'default.html' %}

{% csrf_token %}


{% block content %}
<style>
  .chat-page {
    display: flex;
    justify-content: center;
    padding: 80px 16px 40px;
    box-sizing: border-box;
    min-height: calc(100vh - 160px);
    background: #f5f7fb;
  }

  .chat-wrapper {
    width: 100%;
    max-width: 820px;
    background: #ffffff;
    border-radius: 12px;
    box-shadow: 0 6px 20px rgba(20, 23, 39, 0.08);
    display: flex;
    flex-direction: column;
    overflow: hidden;
    border: 1px solid #e6e9ef;
  }

  .chat-header {
    background: linear-gradient(90deg, #4f46e5, #06b6d4);
    color: white;
    padding: 14px 20px;
    font-weight: 600;
    font-size: 18px;
  }

  .chat-body {
    padding: 16px;
    background: #fbfdff;
    height: 60vh;
    overflow-y: auto;
    box-sizing: border-box;
    border-top: 1px solid #eef2f7;
    border-bottom: 1px solid #eef2f7;
  }

.msg-row {
  display: flex;
  width: 100%;
  margin-bottom: 12px;
  align-items: flex-start;
}

.msg-left {
  justify-content: flex-start;
  text-align: left;
}

.msg-right {
  justify-content: flex-end;
  text-align: right;
}


.msg-bubble {
  display: inline-block;
  padding: 10px 14px;
  border-radius: 16px;
  line-height: 1.4;
  box-sizing: border-box;

  max-width: 65%;
  min-width: 60px;


  word-break: break-word;
  overflow-wrap: anywhere;
  white-space: pre-wrap;
}

/* –õ–µ–≤—ã–π –ø—É–∑—ã—Ä—å */
.msg-left .msg-bubble {
  background: #eef2ff;
  color: #0f172a;
  border: 1px solid #e0e7ff;
  border-top-left-radius: 4px;
}

/* –ü—Ä–∞–≤—ã–π –ø—É–∑—ã—Ä—å */
.msg-right .msg-bubble {
  background: #4f46e5;
  color: #fff;
  border: 1px solid rgba(0,0,0,0.04);
  border-top-right-radius: 4px;
}

  .chat-input {
    display: flex;
    gap: 10px;
    padding: 14px;
    background: #fff;
    align-items: center;
  }

  .chat-input input[type='text'] {
    flex: 1;
    padding: 10px 14px;
    border-radius: 999px;
    border: 1px solid #dbe6f0;
    outline: none;
    font-size: 14px;
  }

  .chat-input input[type='text']:focus {
    box-shadow: 0 0 0 3px rgba(99,102,241,0.08);
    border-color: #6366f1;
  }

  .btn-send {
    background: #6366f1;
    color: #fff;
    padding: 10px 16px;
    border-radius: 999px;
    border: none;
    cursor: pointer;
    font-weight: 600;
  }

  .btn-send:active { transform: translateY(1px); }
  .btn-send:disabled { opacity: .6; cursor: not-allowed; }

  @media (max-width: 600px) {
    .chat-wrapper { max-width: 96%; }
    .chat-body { height: 58vh; padding: 12px; }
    .msg-bubble { max-width: 90%; }
  }
</style>

<div class="chat-page">
  <div class="chat-wrapper" role="region" aria-label="Chat">
    <div class="chat-header">üí¨ –ß–∞—Ç ‚Ññ{{ chat.id }}</div>

    <div id="chat-body" class="chat-body" aria-live="polite">
      {% for msg in messages %}
        <div class="msg-row {% if msg.author == request.user %}msg-right{% else %}msg-left{% endif %}">
          <div>
            <div class="msg-meta">
              <strong>{{ msg.author.username }}</strong> ‚Ä¢ {{ msg.timestamp|date:"Y-m-d H:i" }}
            </div>
            <div class="msg-bubble">{{ msg.content|linebreaksbr }}</div>
          </div>
        </div>
      {% empty %}
        <p id="empty-msg" style="text-align:center;color:#9aa5b1;margin-top:36px;">
          –ò—Å—Ç–æ—Ä–∏—è –ø—É—Å—Ç–∞ ‚Äî –∑–¥–µ—Å—å –±—É–¥—É—Ç —Å–æ–æ–±—â–µ–Ω–∏—è —á–∞—Ç–∞.
        </p>
      {% endfor %}
    </div>

    <div class="chat-input">
      <input id="message-input" type="text" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." autocomplete="off" />
      <button id="send-btn" class="btn-send">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
    </div>
  </div>
</div>

<script>
  const CHAT_ID = {{ chat.id|default:0 }};
  const CURRENT_USER = "{{ request.user.username|escapejs }}".trim().toLowerCase();
  const protocol = window.location.protocol === "https:" ? "wss" : "ws";
  const socket = new WebSocket(`${protocol}://${window.location.host}/ws/chat/${CHAT_ID}/`);

  const chatBody = document.getElementById('chat-body');
  const input = document.getElementById('message-input');
  const sendBtn = document.getElementById('send-btn');
  const emptyMsg = document.getElementById('empty-msg');

  function escapeHtml(unsafe) {
    return unsafe
      .replace(/&/g, "&amp;")
      .replace(/</g, "&lt;")
      .replace(/>/g, "&gt;")
      .replace(/"/g, "&quot;")
      .replace(/'/g, "&#039;");
  }

  function appendMessage(author, text, timestamp) {
    if (!text.trim()) return;

    if (emptyMsg) emptyMsg.remove();

    const isOwn = author.trim().toLowerCase() === CURRENT_USER;
    const row = document.createElement('div');
    row.className = isOwn ? 'msg-row msg-right' : 'msg-row msg-left';

    const meta = document.createElement('div');
    meta.className = 'msg-meta';
    meta.innerHTML = `<strong>${escapeHtml(author)}</strong> ‚Ä¢ ${timestamp || ''}`;

    const bubble = document.createElement('div');
    bubble.className = 'msg-bubble';
    bubble.innerHTML = escapeHtml(text).replace(/\n/g, '<br>');

    const container = document.createElement('div');
    container.appendChild(meta);
    container.appendChild(bubble);

    row.appendChild(container);
    chatBody.appendChild(row);
    chatBody.scrollTop = chatBody.scrollHeight;
  }

  socket.onmessage = function(event) {
    try {
      const data = JSON.parse(event.data);
      appendMessage(data.author, data.message, data.timestamp || '');
    } catch (e) {
      console.error('WS parse error', e);
    }
  };

  socket.onopen = () => console.info('‚úÖ WebSocket –ø–æ–¥–∫–ª—é—á–µ–Ω');
  socket.onclose = (e) => console.warn('‚ö†Ô∏è WebSocket –∑–∞–∫—Ä—ã—Ç', e);
  socket.onerror = (err) => console.error('‚ùå WebSocket –æ—à–∏–±–∫–∞', err);

  function sendMessage() {
    const text = input.value.trim();
    if (!text) return;
    socket.send(JSON.stringify({ message: text }));
    input.value = '';
    input.focus();
  }

  sendBtn.addEventListener('click', sendMessage);
  input.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') sendMessage();
  });

  window.addEventListener('load', () => {
    chatBody.scrollTop = chatBody.scrollHeight;
  });
</script>
 {% endblock content %}